# KI-Personenerkennung System

Ein umfassendes System zur automatisierten Personenerkennung in klassifizierten Bilddaten mit drei verschiedenen KI-Modellen: Ultralytics YOLO, DeepFace und Gemma/LLaVA.

## üöÄ Features

- **Drei KI-Modelle**: Ultralytics YOLO, DeepFace und Gemma/LLaVA f√ºr verschiedene Erkennungsans√§tze
- **Randomisierte Verarbeitung**: Verhindert Bias durch sequenzielle Verarbeitung gleicher Klassifizierungen
- **Konfidenz-Tracking**: Erkennt unsichere Vorhersagen und speichert Wahrscheinlichkeitswerte
- **MySQL Integration**: Vollst√§ndige Speicherung aller Ergebnisse mit Run-Tracking
- **Systemmonitoring**: CPU, RAM und GPU Auslastung w√§hrend der Verarbeitung
- **Cronjob-f√§hig**: Automatisierte Ausf√ºhrung √ºber Zeitpl√§ne
- **Performance-Metriken**: Detaillierte Zeitmessungen pro Bild und Run

## üìÅ Projektstruktur

```
person_detection/
‚îú‚îÄ‚îÄ BaseDetector.py              # Abstrakte Basisklasse f√ºr Detektoren
‚îú‚îÄ‚îÄ DataLoader.py                # L√§dt und verwaltet klassifizierte Bilddaten
‚îú‚îÄ‚îÄ DatabaseHandler.py           # MySQL Datenbankoperationen
‚îú‚îÄ‚îÄ DetectionProcessor.py        # Hauptverarbeitungslogik
‚îú‚îÄ‚îÄ SystemMonitor.py             # Systemressourcen-Monitoring
‚îú‚îÄ‚îÄ UltralyticsPersonDetector.py # YOLO-basierte Personenerkennung
‚îú‚îÄ‚îÄ DeepFacePersonDetector.py    # Gesichtsbasierte Personenerkennung
‚îú‚îÄ‚îÄ GemmaPersonDetector.py       # LLM-basierte Personenerkennung
‚îú‚îÄ‚îÄ run_person_detection.py      # Hauptausf√ºhrungsscript
‚îú‚îÄ‚îÄ setup_environment.py         # Setup und Konfigurationstool
‚îú‚îÄ‚îÄ cronjob_setup.sh            # Cronjob-Automatisierung
‚îú‚îÄ‚îÄ database_schema.sql          # MySQL Datenbankschema
‚îú‚îÄ‚îÄ requirements.txt             # Python-Abh√§ngigkeiten
‚îî‚îÄ‚îÄ README.md                    # Diese Dokumentation
```

## üõ†Ô∏è Installation

### 1. Repository klonen und Setup ausf√ºhren

```bash
git clone <repository-url>
cd person_detection

# Python-Umgebung erstellen (empfohlen)
python3 -m venv venv
source venv/bin/activate

# Setup-Script ausf√ºhren
python3 setup_environment.py --install --test-models --create-testdata ./data
```

### 2. MySQL Datenbank einrichten

```bash
# Datenbank und Tabellen erstellen
mysql -u root -p < database_schema.sql

# Oder mit anderem Benutzer:
mysql -u your_user -p your_database < database_schema.sql
```

### 3. Konfiguration anpassen

Bearbeiten Sie die Datenbankverbindung in `example_run.sh`:

```bash
DB_HOST="localhost"
DB_USER="ai_detection_user"
DB_PASSWORD="your_secure_password"
DB_NAME="ai_detection"
DATA_DIR="/path/to/your/classified/images"
```

## üìä Datenstruktur

### Klassifizierte Bilddaten

Organisieren Sie Ihre Bilder in folgender Struktur:

```
classified_images/
‚îú‚îÄ‚îÄ with_people/
‚îÇ   ‚îú‚îÄ‚îÄ image1.jpg
‚îÇ   ‚îú‚îÄ‚îÄ image2.png
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ without_people/
‚îÇ   ‚îú‚îÄ‚îÄ image3.jpg
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ group_photos/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ uncertain/
    ‚îî‚îÄ‚îÄ ...
```

**Unterst√ºtzte Formate**: `.jpg`, `.jpeg`, `.png`, `.bmp`, `.tiff`, `.tif`, `.webp`

## üéØ Verwendung

### Einzelne Ausf√ºhrung

```bash
# Ultralytics YOLO
python3 run_person_detection.py \
    --model ultralytics \
    --db-host localhost \
    --db-user your_user \
    --db-password your_password \
    --db-name ai_detection \
    --data-dir /path/to/images \
    --max-images 100 \
    --confidence-threshold 0.6

# DeepFace mit MTCNN Backend
python3 run_person_detection.py \
    --model deepface \
    --deepface-backend mtcnn \
    --db-host localhost \
    --db-user your_user \
    --db-password your_password \
    --db-name ai_detection \
    --data-dir /path/to/images \
    --max-images 50 \
    --confidence-threshold 0.5

# Gemma/LLaVA (ben√∂tigt GPU)
python3 run_person_detection.py \
    --model gemma \
    --db-host localhost \
    --db-user your_user \
    --db-password your_password \
    --db-name ai_detection \
    --data-dir /path/to/images \
    --max-images 20 \
    --confidence-threshold 0.7
```

### Automatisierte Ausf√ºhrung (Cronjobs)

```bash
# Cronjob-Script konfigurieren
cp cronjob_setup.sh /path/to/your/cronjob_setup.sh
nano /path/to/your/cronjob_setup.sh  # Pfade anpassen

# Cronjobs installieren
chmod +x /path/to/your/cronjob_setup.sh
/path/to/your/cronjob_setup.sh install-cron
```

**Standard Cronjob-Zeiten:**
- **07:30**: Morgendlicher Schnellscan (Ultralytics)
- **14:00**: Detaillierte Nachmittags-Analyse (Ultralytics + DeepFace)
- **20:00**: Umfassende Abend-Analyse (alle Modelle)
- **So 02:00**: W√∂chentlicher Vollscan
- **01:00**: T√§gliche Log-Bereinigung

## ü§ñ KI-Modelle

### 1. Ultralytics YOLO
- **Typ**: Objekterkennung
- **St√§rken**: Schnell, pr√§zise Bounding Boxes, gut f√ºr Echtzeit
- **Schw√§chen**: Nur vortrainierte Klassen
- **Empfohlene Nutzung**: Hauptscan, gro√üe Bildmengen

### 2. DeepFace
- **Typ**: Gesichtserkennung
- **St√§rken**: Erkennt Personen √ºber Gesichter, verschiedene Backends
- **Schw√§chen**: Nur frontal sichtbare Gesichter
- **Empfohlene Nutzung**: Detailanalyse, Portrait-Bilder

### 3. Gemma/LLaVA
- **Typ**: Vision-Language Model
- **St√§rken**: Versteht Kontext, kann komplexe Szenen analysieren
- **Schw√§chen**: Langsam, hoher GPU-Bedarf, keine exakten Bounding Boxes
- **Empfohlene Nutzung**: Qualit√§tskontrolle, komplexe Szenen

## üìà Datenbankschema

### Tabelle: `ai_runs`
Speichert Informationen √ºber jeden Verarbeitungsdurchlauf:

- `run_id`: Eindeutige Run-ID (UUID)
- `model_name`: Verwendetes KI-Modell
- `start_time`/`end_time`: Zeitstempel
- `total_images`: Anzahl verarbeiteter Bilder
- `successful_detections`/`failed_detections`: Erfolgs-/Fehlerstatistik
- `avg_processing_time`: Durchschnittliche Zeit pro Bild
- `avg_cpu_usage`/`max_cpu_usage`: CPU-Auslastung
- `avg_memory_usage`/`max_memory_usage`: RAM-Auslastung
- `avg_gpu_usage`/`max_gpu_usage`: GPU-Auslastung
- `status`: Run-Status (running/completed/failed/cancelled)
- `config_json`: Verwendete Konfiguration

### Tabelle: `detection_results`
Speichert Einzelergebnisse pro Bild:

- `run_id`: Verkn√ºpfung zum Run
- `image_path`/`image_filename`: Bildidentifikation
- `classification`: Urspr√ºngliche Klassifizierung
- `model_output`: Vollst√§ndige Modellausgabe (JSON)
- `confidence_scores`: Konfidenzwerte als String
- `persons_detected`: Anzahl erkannter Personen
- `avg_confidence`/`max_confidence`/`min_confidence`: Konfidenzstatistiken
- `is_uncertain`: Flag f√ºr unsichere Erkennungen
- `processing_time`: Zeit f√ºr diese Detection
- `success`: Erfolg/Fehler Flag

## üìä Auswertung und Monitoring

### N√ºtzliche SQL-Abfragen

```sql
-- Modellvergleich
SELECT * FROM model_comparison;

-- Klassifizierungsanalyse
SELECT * FROM classification_analysis;

-- Run-√úbersicht der letzten 7 Tage
SELECT * FROM run_overview 
WHERE start_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY start_time DESC;

-- Top 10 Bilder mit den meisten Personen
SELECT image_filename, classification, persons_detected, avg_confidence, run_id
FROM detection_results 
WHERE success = TRUE 
ORDER BY persons_detected DESC, avg_confidence DESC 
LIMIT 10;

-- Unsichere Erkennungen
SELECT classification, COUNT(*) as total,
       COUNT(CASE WHEN is_uncertain = TRUE THEN 1 END) as uncertain,
       ROUND(COUNT(CASE WHEN is_uncertain = TRUE THEN 1 END) / COUNT(*) * 100, 2) as uncertain_percentage
FROM detection_results 
WHERE success = TRUE
GROUP BY classification
ORDER BY uncertain_percentage DESC;
```

## ‚öôÔ∏è Konfigurationsoptionen

### Kommandozeilenparameter

```bash
python3 run_person_detection.py --help
```

**Wichtige Parameter:**
- `--model`: KI-Modell (ultralytics/deepface/gemma)
- `--max-images`: Maximale Bildanzahl pro Run
- `--confidence-threshold`: Mindest-Konfidenz (0.0-1.0)
- `--classifications`: Nur bestimmte Klassifizierungen verarbeiten
- `--no-randomize`: Deaktiviert Randomisierung
- `--run-name`: Name f√ºr den Run (f√ºr Tracking)
- `--job-id`: Job-ID f√ºr Cronjob-Zuordnung

### Modell-spezifische Parameter

**Ultralytics:**
- `--yolo-model-path`: Pfad zum YOLO-Modell (Standard: yolov8n.pt)

**DeepFace:**
- `--deepface-backend`: Backend (opencv/ssd/mtcnn/retinaface)

**Gemma:**
- `--gemma-model`: HuggingFace Modellname

## üêõ Troubleshooting

### H√§ufige Probleme

1. **CUDA/GPU Probleme**
   ```bash
   # GPU-Status pr√ºfen
   nvidia-smi
   
   # Torch CUDA-Verf√ºgbarkeit testen
   python3 -c "import torch; print(torch.cuda.is_available())"
   ```

2. **MySQL Verbindungsfehler**
   ```bash
   # MySQL-Service pr√ºfen
   sudo systemctl status mysql
   
   # Verbindung testen
   mysql -h localhost -u your_user -p
   ```

3. **Speicherprobleme bei Gemma**
   ```bash
   # Reduziere max-images f√ºr Gemma
   --max-images 10
   
   # Oder verwende nur Ultralytics/DeepFace
   ```

4. **Fehlende Abh√§ngigkeiten**
   ```bash
   # Re-Installation
   pip install -r requirements.txt
   
   # Spezifische Pakete
   pip install ultralytics deepface transformers torch
   ```

### Log-Analyse

```bash
# Cronjob-Logs
tail -f logs/cronjob.log

# Spezifische Run-Logs  
tail -f logs/ultralytics_*.log
tail -f logs/deepface_*.log
tail -f logs/gemma_*.log
```

## üîß Erweiterte Konfiguration

### Performance-Optimierung

1. **GPU-Memory f√ºr Gemma begrenzen**
   ```python
   # In GemmaPersonDetector.py
   self.model = LlavaForConditionalGeneration.from_pretrained(
       model_name,
       torch_dtype=torch.float16,
       low_cpu_mem_usage=True,
       max_memory={0: "8GB"}  # Begrenze GPU 0 auf 8GB
   )
   ```

2. **Batch-Processing aktivieren**
   ```python
   # Mehrere Bilder gleichzeitig verarbeiten (f√ºr Ultralytics)
   results = self.model(image_paths, batch=8)
   ```

3. **Systemmonitoring anpassen**
   ```python
   # In SystemMonitor.py - Monitoring-Intervall √§ndern
   time.sleep(1.0)  # Statt 0.5 Sekunden
   ```

### Cronjob-Anpassungen

```bash
# Verschiedene Zeitpl√§ne f√ºr verschiedene Modelle
# Ultralytics: Alle 2 Stunden
0 */2 * * * /path/to/cronjob_setup.sh morning

# DeepFace: Zweimal t√§glich  
0 8,20 * * * /path/to/cronjob_setup.sh afternoon

# Gemma: Einmal t√§glich nachts
0 2 * * * /path/to/cronjob_setup.sh evening
```

## ü§ù Beitragen

1. Fork das Repository
2. Erstelle einen Feature-Branch (`git checkout -b feature/AmazingFeature`)
3. Committe deine √Ñnderungen (`git commit -m 'Add some AmazingFeature'`)
4. Push zum Branch (`git push origin feature/AmazingFeature`)
5. √ñffne einen Pull Request

## üìù Lizenz

Dieses Projekt steht unter der MIT-Lizenz. Siehe `LICENSE` Datei f√ºr Details.

## üôè Danksagungen

- [Ultralytics](https://ultralytics.com/) f√ºr YOLO
- [DeepFace](https://github.com/serengil/deepface) f√ºr Gesichtserkennung
- [HuggingFace](https://huggingface.co/) f√ºr LLaVA/Gemma Modelle
- [MySQL](https://mysql.com/) f√ºr die Datenbank

## üìû Support

Bei Problemen oder Fragen:

1. Pr√ºfe die [Troubleshooting](#-troubleshooting) Sektion
2. Schaue in die [Issues](https://github.com/your-repo/issues)
3. Erstelle ein neues Issue mit detaillierter Beschreibung

---

**Hinweis**: Dieses System wurde f√ºr Debian-Server optimiert und mit Python 3.8+ getestet.